---
layout: post
title: "Combine"
excerpt: ""
categories: [Combine]
comments: true
---

## Publisher 

publisher는 subscibers와 같이 하나 이상의 대상에게 시간이 지남에 따라 값을 방출할 수 있다.

- Output
- Completion
  - Sucess
  - Error

0개 이상의  output을 가질 수 있으며, 성공, 실패하면 더 이상 이벤트가 발생하지 않는다.



### Publisher Protocol

```swift
public protocol Publisher {
 	associatedtype Output
 	associatedtype Failure : Error
  // 2
 	func receive<S>(subscriber: S)
 		where S: Subscriber,
 		Self.Failure == S.Failure,
 		Self.Output == S.Input
 }
 
 extension Publisher {
	// 1
 	public func subscribe<S>(_ subscriber: S)
 		where S : Subscriber,
 		Self.Failure == S.Failure,
 		Self.Output == S.Input
 }
```

- 1: subscriber는 publisher의  subcribe(_:) 을 호출할 수 있다. 
- 2: subscibe(_: ) 구현체는 receive(subscriber: )호출하여 subscriber를 publisher에 연결한다. (subscription을 만든다.)



## Operators 

Publisher Protocol 와 Subscriber Protocol을 채택한다.

publisher에게 구독하도록 도와주고, subscriber에게 값을 전달하기도 한다.

publisher protocol로 선언된 method이며, 선언된 publisher와 동일하거나 새로운 publisher를 반환한다.

output이 다음 input하고 타입이 일치하지 않으면 결합할 수 없다. (input, output을 upstream, downstream이라고 표현한다.)

여러 operator를 차례로 호출해서 체인할 수 있기 때문에 유용하다. 

operator는 이전 operator로 부터 받은 데이터 작업을 중점으로 두고 그 결과를 다음 체인 operator에게 제공한다. (비동기적으로 실행되는 다른 코드는 작업 중인 데이터를 건너뛰고 변경할 수 없다.) -> 비동기작업을 순차적으로 진행한다는 뜻인거 같다.



## Subscribers

subscriber는 방충된 값, 완료 이벤트를 통해 "무언가"를 하는 역할이다.

모든 subscirption은 subscriber와 함께 종료된다. 

- sink(receiveCompletion: , receiveValue: ): subscriber는 output 값, 완료를 수신할 수 있는 closure를 제공
- assign(to: , on: ): subsciber가 output을 객체, UI control의 특정 속성에 바인딩한다. ( keyPath를 사용한다.)

publisher는 최소 한개 이상의 subscriber를 가져야 값을 방출한다.



### Subscriber Protocol

```swift
public protocol Subscriber: CustomCombineIdentifierConvertible {
 	associatedtype Input
 	associatedtype Failure: Error
	// 1
 	func receive(subscription: Subscription)
  // 2
 	func receive(_ input: Self.Input) -> Subscribers.Demand
  // 3
 	func receive(completion: Subscribers.Completion<Self.Failure>)
 }
```

- 1: publisher가 subscription을 전달하기 위해 subscriber의 receive(subscription: )을 호출한다.
- 2: publisher가 새로운 값을 방출하면 subscriber에게 전달하기 위해서 receive(_: )을 호출한다.
- 3: publisher가 값 생성이 종료되거나 error가 발생했을 때 이벤트를 알리기 위해서 receive(completion: )을 호출한다.



## Subscriptions

Subscription protocol 하고 object, publisher, operator, subscriber 전체 체인을 의미하나는 용도로도 사용.

subscription은 사용자 정의 코드 및 에러처리를 사용하여 비동기 이벤트 체인을 한 번만 선언할 수 있다.

Cancellable protocol은 subscription을 메모리로 관리할 필요가 없다. (scope 밖으로 나가면 cancel()이 호출된다.)

장시간 실행되는 비동기 작업의 경우 subscription을 저장하지 않고 scope밖으로 나가면 즉시 subscription이 취소된다. (Set<AnyCancelable>에 저장할 수 있다.)



```swift
    let subscription =
        publisher
            .sink { _ in print("Notification received from a publisher!") }
```

sink라는 subscription을 publisher에 생성한다.

subcriber에게 closure를 연결하여 publisher의 output을 처리한다. 



### Subscription Protocol

```swift
 public protocol Subscription: Cancellable, CustomCombineIdentifierConvertible {
 			func request(_ demand: Subscribers.Demand)
 }
```

publisher와 subsciber는 subscription을 통해 연결된다. 

subscriber는 request(_: )을 호출하여 최대 또는 무한으로 값을 받을 수 있음을 나타낸다. (backpressure 관리라고 한다.)





## Cancellable 

subscription은 AnyCancellable의 취소 토크을 반환하기 때문에 subscription이 필요 없어지면 subscription을 취소할 수 있다.







## Flow 

![1  flow](https://user-images.githubusercontent.com/48466830/81884579-364ee680-95d3-11ea-97cb-a69c26f7b672.png)





## Future

단일 결과를 비동기적으로 생성한 다음 완료된다.

하나의 값을 만들어 완료되거나 실패될 publisher이다.

값이나 error가 있을 때 closure를 호출하여 이를 수행하며, 이 closure를 promise라고 한다







switchToLatest

merge 싱크 신경 안씀

Zip 싱크가 맞음











pre fetching이 좋은 것만은 아니다. Cuz 사용하지 않는 데이터를 받아오기때문이다.











